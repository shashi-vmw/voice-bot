<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Groww IPO Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #121212; color: white; }
        .pulse-ring {
            animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
        @keyframes pulse-ring {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 209, 130, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 20px rgba(0, 209, 130, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 209, 130, 0); }
        }
        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 24px;
            max-width: 480px;
            margin: 0 auto;
            position: relative;
            background-color: #181A20;
        }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="flex items-center justify-between mt-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-emerald-500 rounded-full flex items-center justify-center font-bold text-lg">G</div>
                <div>
                    <h1 class="text-lg font-semibold">IPO Support</h1>
                    <p class="text-xs text-gray-400">Native AI (16kHz) â€¢ Online</p>
                </div>
            </div>
        </div>

        <div class="flex-1 flex flex-col items-center justify-center relative">
            <div id="mic-icon" class="w-32 h-32 bg-gray-800 rounded-full flex items-center justify-center transition-all duration-500">
                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#00D182" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="22"/></svg>
            </div>
            <p id="status-text" class="mt-8 text-gray-400 font-medium text-center">Ready to connect</p>
        </div>

        <div class="mb-8">
            <button id="start-btn" onclick="startSession()" class="w-full bg-[#00D182] hover:bg-[#00b06d] text-black font-bold py-4 rounded-2xl transition-all shadow-lg shadow-emerald-900/20 active:scale-95">
                Start Voice Chat
            </button>
            <button id="end-btn" onclick="endSession()" class="hidden w-full bg-red-500 hover:bg-red-600 text-white font-bold py-4 rounded-2xl transition-all active:scale-95">
                End Call
            </button>
        </div>
    </div>

    <script>
        let ws;
        let audioContext;
        let processor;
        let inputSource;
        let nextStartTime = 0;
        const TARGET_SAMPLE_RATE = 16000;

        async function startSession() {
            const startBtn = document.getElementById('start-btn');
            const statusText = document.getElementById('status-text');
            const micIcon = document.getElementById('mic-icon');

            startBtn.disabled = true;
            statusText.textContent = "Connecting...";

            try {
                // Initialize Audio Context
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                await audioContext.resume();

                // Setup WebSocket
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                ws = new WebSocket(`${protocol}//${window.location.host}/ws/stream`);

                ws.onopen = async () => {
                    statusText.textContent = "Listening...";
                    micIcon.classList.add('pulse-ring');
                    startBtn.classList.add('hidden');
                    document.getElementById('end-btn').classList.remove('hidden');
                    startRecording();
                };

                ws.onmessage = async (event) => {
                    const msg = JSON.parse(event.data);
                    if (msg.type === 'audio') {
                        playAudio(msg.data);
                    }
                };

                ws.onclose = () => endSession();

            } catch (err) {
                console.error(err);
                alert("Error: " + err.message);
                endSession();
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                inputSource = audioContext.createMediaStreamSource(stream);
                
                // Use ScriptProcessor for raw access
                processor = audioContext.createScriptProcessor(4096, 1, 1);
                
                processor.onaudioprocess = (e) => {
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        const inputData = e.inputBuffer.getChannelData(0);
                        
                        // FIX: Downsample to 16kHz
                        const downsampledData = downsampleBuffer(inputData, audioContext.sampleRate, TARGET_SAMPLE_RATE);
                        
                        // Convert to Base64 (Int16 PCM)
                        const base64Audio = btoa(String.fromCharCode(...new Uint8Array(downsampledData.buffer)));
                        ws.send(JSON.stringify({ type: 'audio', data: base64Audio }));
                    }
                };

                inputSource.connect(processor);
                processor.connect(audioContext.destination);
            } catch (err) {
                console.error("Mic Error:", err);
            }
        }

        // Helper: Downsample Buffer
        function downsampleBuffer(buffer, sampleRate, outSampleRate) {
            if (outSampleRate === sampleRate) {
                return convertFloat32ToInt16(buffer);
            }
            if (outSampleRate > sampleRate) {
                throw "Downsampling rate show be smaller than original rate";
            }
            const sampleRateRatio = sampleRate / outSampleRate;
            const newLength = Math.round(buffer.length / sampleRateRatio);
            const result = new Int16Array(newLength);
            let offsetResult = 0;
            let offsetBuffer = 0;
            while (offsetResult < result.length) {
                const nextOffsetBuffer = Math.round((offsetResult + 1) * sampleRateRatio);
                let accum = 0, count = 0;
                for (let i = offsetBuffer; i < nextOffsetBuffer && i < buffer.length; i++) {
                    accum += buffer[i];
                    count++;
                }
                result[offsetResult] = Math.min(1, accum / count) * 0x7FFF;
                offsetResult++;
                offsetBuffer = nextOffsetBuffer;
            }
            return result;
        }

        function convertFloat32ToInt16(buffer) {
            let l = buffer.length;
            const buf = new Int16Array(l);
            while (l--) {
                buf[l] = Math.min(1, buffer[l]) * 0x7FFF;
            }
            return buf;
        }

        function playAudio(base64Data) {
            const binaryString = window.atob(base64Data);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            const int16Data = new Int16Array(bytes.buffer);
            const float32Data = new Float32Array(int16Data.length);
            for (let i = 0; i < int16Data.length; i++) {
                float32Data[i] = int16Data[i] / 0x8000;
            }

            // Gemini Output is 24kHz
            const buffer = audioContext.createBuffer(1, float32Data.length, 24000);
            buffer.getChannelData(0).set(float32Data);

            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            source.connect(audioContext.destination);
            
            const currentTime = audioContext.currentTime;
            if (nextStartTime < currentTime) nextStartTime = currentTime;
            source.start(nextStartTime);
            nextStartTime += buffer.duration;
        }

        function endSession() {
            if (ws) ws.close();
            if (inputSource) inputSource.disconnect();
            if (processor) processor.disconnect();
            if (audioContext) audioContext.close();
            
            document.getElementById('start-btn').disabled = false;
            document.getElementById('start-btn').classList.remove('hidden');
            document.getElementById('end-btn').classList.add('hidden');
            document.getElementById('status-text').textContent = "Disconnected";
            document.getElementById('mic-icon').classList.remove('pulse-ring');
        }
    </script>
</body>
</html>